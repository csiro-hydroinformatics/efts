---
title: "Introduction to the efts R package"
author: "Jean-Michel Perraud"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to the efts R package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  error = FALSE,
  tidy = FALSE,
  out.extra='style="display:block; margin: auto"', 
  fig.align="center", 
  fig.width=12, 
  fig.height=6, 
  dev='png'
)
library(efts)
```

## Overview

**efts** is an R package to access ensemble forecast time series stored (EFTS) in netCDF format. It offers convenient functions to access time series, hiding the bug-prone details of netCDF array manipulations. 

EFTS netCDF data sets follow the schema described at [this location](https://github.com/jmp75/efts/blob/master/docs/netcdf_for_water_forecasting.md) at the time of writing.

The package comes with API documentation, as well as the present vignette. You can access both navigating via

```
?efts
```

## 

```{r}
ext_data <- system.file('extdata', package='efts')
rain_file <- file.path(ext_data, 'Upper_Murray_sample_rain.nc')
stopifnot(file.exists(rain_file))

rain_dat <- open_efts(rain_file)
rain_dat
```
```{r}
rain_dat$get_lead_time_count()
rain_dat$get_station_count()

d <- rain_dat$get_all_series(variable_name = 'rain_der')
str(d)
# How do we silence 
# Warning message:
# timezone of object (UTC) is different than current timezone (). 
```
```{r}
plot(d[1:48], main="Interpolated rainfall (mm/h)")
```
```{r}
d_q <- rain_dat$get_all_series(variable_name = 'rain_der_qual')
plot(d_q, main="Interpolated rainfall quality code")

# Note: the following is not enough as an error msg:
# > d <- rain_dat$get_all_series()
# Error: variable_name %in% names(ncfile$var) is not TRUE

```
```{r}
rain_dat$close()
```
```{r}
ext_data <- system.file('extdata', package='efts')
ens_fcast_file <- file.path(ext_data, 'Upper_Murray_sample_ensemble_rain_fcast.nc')
stopifnot(file.exists(ens_fcast_file))
rain_fct_ens <- open_efts(ens_fcast_file)
rain_fct_ens
```
```{r}
all_vars_names <- rain_fct_ens$get_variable_names()
station_ids <- rain_fct_ens$get_values("station_id")
variable_names <- "rain_fcast_ens"
issue_times <- rain_fct_ens$get_time_dim()
```
```{r}
ensfcasts = list()
ensfcasts[["1"]] <- rain_fct_ens$get_ensemble_forecasts(variable_names[1], station_ids[1], start_time = issue_times[1])
ensfcasts[["2"]] <- rain_fct_ens$get_ensemble_forecasts(variable_names[1], station_ids[1], start_time = issue_times[2])

# Note: method with signature ‘Duration#ANY’ chosen for function ‘*’,
#  target signature ‘Duration#array’.
#  "vector#structure" would also be valid

d <- ensfcasts[["1"]]
# TODO: would be nice to have the title retrieved, but not realistic for multivariate files
dat_desc <- "Post Processed ACCESS-G (APS1) Rainfall Forecasts"
plot(d[,1:3], main=paste0(dat_desc, " (mm/h)"))

d <- ensfcasts[["2"]]
# TODO: would be nice to have the title retrieved, but not realistic for multivariate files
dat_desc <- "Post Processed ACCESS-G (APS1) Rainfall Forecasts"
plot(d[,1:3], main=paste0(dat_desc, " (mm/h)"))

rain_fct_ens$close()
```